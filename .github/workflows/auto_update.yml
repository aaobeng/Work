name: Ghana & Sports Mega-Sync

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch Feeds
        shell: bash
        run: |
          mkdir -p public
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          curl -sL -A "$UA" "https://www.ghanaweb.com/rss/home.php" -o public/gh_ghanaweb.xml
          curl -sL -A "$UA" "https://www.graphic.com.gh/rss.xml" -o public/gh_graphic.xml
          curl -sL -A "$UA" "https://www.pulse.com.gh/feeds/news" -o public/gh_pulse.xml
          curl -sL -A "$UA" "https://citinewsroom.com/feed/" -o public/gh_citi.xml
          curl -sL -A "$UA" "https://www.myjoyonline.com/feed/" -o public/gh_joy.xml
          curl -sL -A "$UA" "https://ghanasoccernet.com/feed" -o public/gh_footy.xml
          curl -sL -A "$UA" "https://www.myjoyonline.com/sports/feed/" -o public/gh_joy_sports.xml
          curl -sL -A "$UA" "https://www.modernghana.com/sports/rss.xml" -o public/gh_modern_sports.xml
          curl -sL -A "$UA" "https://footballmadeinghana.com/feed/" -o public/gh_fm_football.xml
          curl -sL -A "$UA" "https://www.skysports.com/rss/12040" -o public/intl_skyfootball.xml
          curl -sL -A "$UA" "https://www.fifa.com/rss/index.xml" -o public/intl_fifa.xml
          curl -sL -A "$UA" "https://www.espn.com/espn/rss/soccer/news" -o public/intl_espn.xml
          curl -sL -A "$UA" "http://feeds.bbci.co.uk/sport/football/rss.xml" -o public/intl_bbcfootball.xml
          curl -sL -A "$UA" "https://www.premierleague.com/rss/news.xml" -o public/intl_premierleague.xml
          curl -sL -A "$UA" "https://www.laliga.com/en-GB/rss" -o public/intl_laliga.xml
          curl -sL -A "$UA" "https://www.bundesliga.com/en/bundesliga/news/feed" -o public/intl_bundesliga.xml
          curl -sL -A "$UA" "https://www.legaseriea.it/en/feeds/news.xml" -o public/intl_seriea.xml
          curl -sL -A "$UA" "https://www.ligue1.com/rss" -o public/intl_ligue1.xml
          curl -sL -A "$UA" "https://www.uefa.com/rssfeed/uefachampionsleague/" -o public/intl_uefachampions.xml
          curl -sL -A "$UA" "https://www.uefa.com/rssfeed/uefaeuropaleague/" -o public/intl_uefaeuropa.xml
          curl -sL -A "$UA" "https://www.mlssoccer.com/rss" -o public/intl_mls.xml
          curl -sL -A "$UA" "https://www.cbf.com.br/rss" -o public/intl_brasileirao.xml
          curl -sL -A "$UA" "https://www.skysports.com/rss/12433" -o public/sports_f1.xml
          curl -sL -A "$UA" "https://www.skysports.com/rss/12110" -o public/sports_tennis.xml
          curl -sL -A "$UA" "https://www.espn.com/espn/rss/nba/news" -o public/sports_basketball.xml
          curl -sL -A "$UA" "http://rss.cnn.com/rss/edition.rss" -o public/intl_cnn.xml
          curl -sL -A "$UA" "http://feeds.bbci.co.uk/news/world/rss.xml" -o public/intl_bbc.xml
          curl -sL -A "$UA" "https://www.aljazeera.com/xml/rss/all.xml" -o public/intl_aljazeera.xml

      - name: Process
        shell: bash
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET
          import os
          from datetime import datetime, timedelta, timezone
          from email.utils import parsedate_to_datetime
          def parse_rss(path):
              if not os.path.exists(path) or os.path.getsize(path) < 300: return []
              try: return ET.parse(path).getroot().findall('.//item')
              except: return []
          def is_recent(item):
              pb = item.find('pubDate')
              if pb is None or not pb.text: return False
              try:
                  dt = parsedate_to_datetime(pb.text)
                  if dt.tzinfo is None: dt = dt.replace(tzinfo=timezone.utc)
                  return datetime.now(timezone.utc) - dt <= timedelta(hours=24)
              except: return False
          def merge(files, out, title):
              items = []
              if os.path.exists(out): items.extend(parse_rss(out))
              for f in files: items.extend(parse_rss(f))
              seen, final = set(), []
              for i in items:
                  l = i.find('link')
                  u = l.text.strip() if l is not None and l.text else None
                  if u and u not in seen and is_recent(i):
                      seen.add(u); final.append(i)
              r = ET.Element('rss', version='2.0')
              c = ET.SubElement(r, 'channel')
              ET.SubElement(c, 'title').text = title
              ET.SubElement(c, 'lastBuildDate').text = datetime.now(timezone.utc).strftime('%a, %d %b %Y %H:%M:%S GMT')
              for x in final: c.append(x)
              ET.ElementTree(r).write(out, encoding='utf-8', xml_declaration=True)
          news = ["public/gh_ghanaweb.xml","public/gh_graphic.xml","public/gh_pulse.xml","public/gh_citi.xml","public/gh_joy.xml","public/intl_cnn.xml","public/intl_bbc.xml","public/intl_aljazeera.xml"]
          foot = ["public/gh_footy.xml","public/gh_joy_sports.xml","public/gh_modern_sports.xml","public/gh_fm_football.xml","public/intl_skyfootball.xml","public/intl_fifa.xml","public/intl_espn.xml","public/intl_bbcfootball.xml","public/intl_premierleague.xml","public/intl_laliga.xml","public/intl_bundesliga.xml","public/intl_seriea.xml","public/intl_ligue1.xml","public/intl_uefachampions.xml","public/intl_uefaeuropa.xml","public/intl_mls.xml","public/intl_brasileirao.xml"]
          misc = ["public/sports_f1.xml","public/sports_tennis.xml","public/sports_basketball.xml"]
          merge(news, "public/news.xml", "MegaSync News")
          merge(foot, "public/football.xml", "MegaSync Football")
          merge(misc, "public/other_sports.xml", "MegaSync Other")
          EOF

      - name: Deploy
        run: |
          git config --global user.name "SkyBot"
          git config --global user.email "actions@github.com"
          echo "{\"lastUpdated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > public/status.json
          git add public/
          git commit -m "üå™Ô∏è Sync: $(date -u +%H:%M) UTC" || exit 0
          git push
